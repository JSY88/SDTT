<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- 기존 스타일 및 외부 스크립트 생략 -->
</head>
<body>
    <!-- 기존 HTML 구조 생략 -->
    <div id="tocOverlay">
        <button id="closeToc" style="position: absolute; top: 10px; right: 10px; padding: 5px; background: #fff; border: none; cursor: pointer;">X</button>
        <div id="tocContent"></div>
    </div>

    <script>
        // 기존 변수 선언 및 초기화 생략

        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                message.innerText = '파일을 선택해주세요.';
                message.style.display = 'block';
                loadingSpinner.style.display = 'none';
                return;
            }

            lastFileName = file.name;
            textContent.style.opacity = 1;
            message.innerText = '파일 로딩 중...';
            message.style.display = 'block';
            progress.value = 0;
            toggleButtons(true);
            loadingSpinner.style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(event) {
                const fileData = event.target.result;
                if (file.name.endsWith('.txt')) {
                    if (worker) {
                        worker.onmessage = function(e) {
                            pages = e.data.pages;
                            loadLastPage();
                            preloadPages();
                            displayPage();
                            message.style.display = 'none';
                            progress.value = 0;
                            toggleButtons(false);
                            loadingSpinner.style.display = 'none';
                        };
                        worker.onerror = function(e) {
                            message.innerText = '웹 워커 오류: ' + e.message;
                            message.style.display = 'block';
                            toggleButtons(false);
                            loadingSpinner.style.display = 'none';
                        };
                        worker.postMessage({ text: fileData, maxHeight: textContent.getBoundingClientRect().height });
                    } else {
                        pages = splitTextToFit(fileData, textContent.getBoundingClientRect().height);
                        loadLastPage();
                        preloadPages();
                        displayPage();
                        message.style.display = 'none';
                        progress.value = 0;
                        toggleButtons(false);
                        loadingSpinner.style.display = 'none';
                    }
                } else if (file.name.endsWith('.epub')) {
                    if (!window.ePub || !window.JSZip) {
                        message.innerText = 'epub.js 또는 JSZip 로딩 실패.';
                        message.style.display = 'block';
                        toggleButtons(false);
                        loadingSpinner.style.display = 'none';
                        return;
                    }
                    book = window.ePub(fileData);
                    book.ready.then(() => {
                        message.innerText = 'EPUB 파싱 중...';
                        loadEpubPages().then(pagesData => {
                            pages = pagesData;
                            book.loaded.navigation.then(nav => {
                                toc = nav.toc;
                                console.log('TOC 로드 성공:', toc); // TOC 데이터 확인
                            }).catch(err => console.error('TOC 로드 실패:', err));
                            loadLastPage();
                            preloadPages();
                            displayPage();
                            message.style.display = 'none';
                            progress.value = 0;
                            toggleButtons(false);
                            loadingSpinner.style.display = 'none';
                        });
                    }).catch(err => {
                        message.innerText = 'EPUB 로드 오류: ' + err.message;
                        message.style.display = 'block';
                        toggleButtons(false);
                        loadingSpinner.style.display = 'none';
                    });
                }
            };
            reader.onerror = function() {
                message.innerText = '파일 읽기 오류.';
                message.style.display = 'block';
                toggleButtons(false);
                loadingSpinner.style.display = 'none';
            };
            if (file.name.endsWith('.txt')) {
                reader.readAsText(file, 'UTF-8');
            } else if (file.name.endsWith('.epub')) {
                reader.readAsArrayBuffer(file);
            }
        });

        // 기존 함수들 생략 (splitTextToFit, preloadPages, displayPage 등)

        let tapCount = 0;
        textContent.addEventListener('touchstart', (e) => {
            tapCount++;
            setTimeout(() => tapCount = 0, 300);
            if (tapCount === 2 && book) {
                showToc();
            }
        });

        function showToc() {
            if (toc.length === 0) {
                console.log('TOC 데이터 없음');
                message.innerText = '목차가 없습니다.';
                message.style.display = 'block';
                setTimeout(() => message.style.display = 'none', 2000);
                return;
            }
            console.log('TOC 표시 시도:', toc);
            const tocContent = document.getElementById('tocContent');
            tocContent.innerHTML = '<ul>' + toc.map((item, index) => {
                return `<li data-page="${index}">${item.label || '제목 없음'}</li>`;
            }).join('') + '</ul>';
            tocOverlay.style.display = 'block';

            // 각 목차 항목에 클릭 이벤트 추가
            tocContent.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', (e) => {
                    e.stopPropagation(); // 오버레이 닫기 방지
                    const pageIndex = parseInt(li.dataset.page);
                    console.log('목차 항목 클릭:', pageIndex, li.innerText);
                    currentPage = pageIndex;
                    stopEffect();
                    displayPage();
                    tocOverlay.style.display = 'none';
                });
            });

            // 닫기 버튼 이벤트
            document.getElementById('closeToc').addEventListener('click', (e) => {
                e.stopPropagation();
                tocOverlay.style.display = 'none';
            });
        }

        // 나머지 함수들 생략 (startEffect, stopEffect 등)
    </script>
</body>
</html>
